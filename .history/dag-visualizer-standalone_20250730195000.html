<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”— DAGå·¥ä½œæµå¯è§†åŒ–å™¨ - ç‹¬ç«‹ç‰ˆæœ¬</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
            color: #262626;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header h1 {
            color: #1890ff;
            margin: 0 0 10px 0;
            font-size: 2rem;
        }
        
        .header p {
            color: #8c8c8c;
            margin: 0 0 20px 0;
        }
        
        .controls {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .controls h2 {
            margin-top: 0;
            color: #262626;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #1890ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            background: #40a9ff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(24,144,255,0.3);
        }
        
        .btn-secondary {
            background: #52c41a;
        }
        
        .btn-secondary:hover {
            background: #73d13d;
        }
        
        .btn-warning {
            background: #faad14;
        }
        
        .btn-warning:hover {
            background: #ffc53d;
        }
        
        .canvas-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            min-height: 400px;
            position: relative;
        }
        
        .status {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .status-success {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        
        .status-error {
            background: #fff2f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }
        
        .status-info {
            background: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
        }
        
        .file-drop-zone {
            border: 2px dashed #d9d9d9;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            color: #8c8c8c;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .file-drop-zone:hover {
            border-color: #1890ff;
            color: #1890ff;
            background: #f6f8fa;
        }
        
        .file-drop-zone.dragover {
            border-color: #52c41a;
            background: #f6ffed;
            color: #52c41a;
        }
        
        #file-input {
            display: none;
        }
        
        #dag-canvas {
            width: 100%;
            height: 500px;
            border: 1px solid #f0f0f0;
            border-radius: 6px;
        }
        
        .node {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .node:hover {
            filter: brightness(1.1);
            stroke-width: 3;
        }
        
        .node.selected {
            stroke: #ff4d4f;
            stroke-width: 3;
        }
        
        .edge {
            stroke: #595959;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }
        
        .edge.highlighted {
            stroke: #ff4d4f;
            stroke-width: 3;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid;
        }
        
        .alert-warning {
            background: #fffbe6;
            border-color: #faad14;
            color: #d48806;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”— DAGå·¥ä½œæµå¯è§†åŒ–å™¨</h1>
            <p>ç‹¬ç«‹ç‰ˆæœ¬ - æ— éœ€Tampermonkeyï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ</p>
            <div class="status status-info">
                âœ… é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨ï¼è¿™æ˜¯Tampermonkeyçš„å®Œç¾æ›¿ä»£æ–¹æ¡ˆã€‚
            </div>
        </div>

        <div class="alert alert-warning">
            <strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong> 
            è¿™æ˜¯ç‹¬ç«‹çš„HTMLç‰ˆæœ¬ï¼Œä¸ä¾èµ–ä»»ä½•æµè§ˆå™¨æ‰©å±•ã€‚æ‚¨å¯ä»¥å°†æ­¤æ–‡ä»¶ä¿å­˜åˆ°æœ¬åœ°ï¼Œéšæ—¶åŒå‡»æ‰“å¼€ä½¿ç”¨ã€‚
            æ”¯æŒæ‰€æœ‰åŸæœ‰åŠŸèƒ½ï¼šæ–‡ä»¶ä¸Šä¼ ã€èŠ‚ç‚¹å¯è§†åŒ–ã€äº¤äº’é€‰æ‹©ç­‰ã€‚
        </div>

        <div class="controls">
            <h2>ğŸ“ æ–‡ä»¶æ“ä½œ</h2>
            
            <div class="btn-group">
                <button class="btn" onclick="triggerFileUpload()">ğŸ“ é€‰æ‹©JSONæ–‡ä»¶</button>
                <button class="btn btn-secondary" onclick="loadSampleData()">ğŸ§ª åŠ è½½ç¤ºä¾‹æ•°æ®</button>
                <button class="btn btn-warning" onclick="exportConfig()">ğŸ’¾ å¯¼å‡ºé…ç½®</button>
                <button class="btn" onclick="clearCanvas()">ğŸ—‘ï¸ æ¸…ç©ºç”»å¸ƒ</button>
            </div>
            
            <input type="file" id="file-input" accept=".json" onchange="handleFileUpload(event)">
            
            <div class="file-drop-zone" onclick="triggerFileUpload()" 
                 ondrop="handleFileDrop(event)" 
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)">
                ğŸ“ ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ æˆ– æ‹–æ‹½JSONæ–‡ä»¶åˆ°æ­¤å¤„
            </div>
            
            <div id="status-message" class="status status-info">
                å‡†å¤‡å°±ç»ª - è¯·ä¸Šä¼ JSONæ–‡ä»¶å¼€å§‹å¯è§†åŒ–
            </div>
        </div>

        <div class="canvas-container">
            <h2>ğŸ¨ DAGå¯è§†åŒ–ç”»å¸ƒ</h2>
            <svg id="dag-canvas" viewBox="0 0 1000 500">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                            refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#595959" />
                    </marker>
                    <marker id="arrowhead-highlight" markerWidth="10" markerHeight="7" 
                            refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#ff4d4f" />
                    </marker>
                </defs>
                
                <g id="edges-group"></g>
                <g id="nodes-group"></g>
                
                <text x="500" y="250" text-anchor="middle" fill="#8c8c8c" font-size="18">
                    è¯·ä¸Šä¼ JSONæ–‡ä»¶å¼€å§‹å¯è§†åŒ–
                </text>
            </svg>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let nodes = [];
        let edges = [];
        let selectedNode = null;

        // èŠ‚ç‚¹ç±»å‹é…ç½®
        const nodeTypes = {
            'PROMPT_BUILD': { color: '#52c41a', textColor: '#ffffff' },
            'CALL_LLM': { color: '#faad14', textColor: '#000000' },
            'HTTP_REQUEST': { color: '#ff4d4f', textColor: '#ffffff' },
            'CODE_EXEC': { color: '#722ed1', textColor: '#ffffff' },
            'UNKNOWN': { color: '#8c8c8c', textColor: '#ffffff' }
        };

        // æ›´æ–°çŠ¶æ€ä¿¡æ¯
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status-message');
            statusElement.className = `status status-${type}`;
            statusElement.textContent = message;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // è§¦å‘æ–‡ä»¶é€‰æ‹©
        function triggerFileUpload() {
            document.getElementById('file-input').click();
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.json')) {
                updateStatus('âŒ è¯·é€‰æ‹©JSONæ ¼å¼æ–‡ä»¶', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    loadDAGData(jsonData, file.name);
                } catch (error) {
                    updateStatus('âŒ JSONæ–‡ä»¶è§£æå¤±è´¥: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // å¤„ç†æ‹–æ‹½
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const fakeEvent = { target: { files: [files[0]] } };
                handleFileUpload(fakeEvent);
            }
        }

        // åŠ è½½DAGæ•°æ®
        function loadDAGData(jsonData, filename) {
            updateStatus('â³ æ­£åœ¨è§£æDAGæ•°æ®...', 'info');

            try {
                const parsedData = parseDAGJson(jsonData);
                nodes = parsedData.nodes;
                edges = parsedData.edges;

                if (nodes.length === 0) {
                    updateStatus('âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„DAGèŠ‚ç‚¹æ•°æ®', 'error');
                    return;
                }

                calculateLayout();
                renderDAG();
                
                updateStatus(
                    `âœ… æˆåŠŸåŠ è½½ ${filename} - ${nodes.length}ä¸ªèŠ‚ç‚¹ï¼Œ${edges.length}æ¡è¿çº¿`, 
                    'success'
                );
                
            } catch (error) {
                updateStatus('âŒ æ•°æ®å¤„ç†å¤±è´¥: ' + error.message, 'error');
                console.error('DAGæ•°æ®åŠ è½½é”™è¯¯:', error);
            }
        }

        // è§£æJSONæ•°æ®
        function parseDAGJson(jsonData) {
            const parsedNodes = [];
            const parsedEdges = [];
            
            const tasks = Array.isArray(jsonData) ? jsonData : (jsonData.tasks || []);
            
            tasks.forEach((task, index) => {
                if (!task || typeof task !== 'object') return;
                
                const nodeType = extractNodeType(task['@type'] || task.type || 'UNKNOWN');
                const nodeId = task.taskId || `node_${index}`;
                
                parsedNodes.push({
                    id: nodeId,
                    type: nodeType,
                    label: nodeType,
                    x: 0, 
                    y: 0
                });
                
                const dependencies = task.dependencies || [];
                dependencies.forEach(dep => {
                    if (dep && typeof dep === 'string') {
                        parsedEdges.push({
                            source: dep,
                            target: nodeId
                        });
                    }
                });
            });
            
            return { nodes: parsedNodes, edges: parsedEdges };
        }

        // æå–èŠ‚ç‚¹ç±»å‹
        function extractNodeType(typeString) {
            if (!typeString) return 'UNKNOWN';
            
            const type = typeString.toLowerCase();
            if (type.includes('templatetransform') || type.includes('prompt_build')) return 'PROMPT_BUILD';
            if (type.includes('llm') || type.includes('call_llm')) return 'CALL_LLM';
            if (type.includes('httprequest') || type.includes('http_request')) return 'HTTP_REQUEST';
            if (type.includes('code') || type.includes('exec')) return 'CODE_EXEC';
            
            return 'UNKNOWN';
        }

        // è®¡ç®—å¸ƒå±€
        function calculateLayout() {
            // ç®€å•ç½‘æ ¼å¸ƒå±€
            const cols = Math.ceil(Math.sqrt(nodes.length));
            const nodeWidth = 120;
            const nodeHeight = 60;
            const spacingX = 150;
            const spacingY = 80;
            
            nodes.forEach((node, index) => {
                const col = index % cols;
                const row = Math.floor(index / cols);
                node.x = 100 + col * spacingX;
                node.y = 50 + row * spacingY;
            });
        }

        // æ¸²æŸ“DAG
        function renderDAG() {
            const svg = document.getElementById('dag-canvas');
            const nodesGroup = document.getElementById('nodes-group');
            const edgesGroup = document.getElementById('edges-group');
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            nodesGroup.innerHTML = '';
            edgesGroup.innerHTML = '';
            
            // æ¸²æŸ“è¿çº¿
            edges.forEach(edge => {
                const sourceNode = nodes.find(n => n.id === edge.source);
                const targetNode = nodes.find(n => n.id === edge.target);
                
                if (sourceNode && targetNode) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('class', 'edge');
                    line.setAttribute('x1', sourceNode.x + 60);
                    line.setAttribute('y1', sourceNode.y);
                    line.setAttribute('x2', targetNode.x - 60);
                    line.setAttribute('y2', targetNode.y);
                    line.setAttribute('data-source', edge.source);
                    line.setAttribute('data-target', edge.target);
                    edgesGroup.appendChild(line);
                }
            });
            
            // æ¸²æŸ“èŠ‚ç‚¹
            nodes.forEach(node => {
                const nodeConfig = nodeTypes[node.type] || nodeTypes['UNKNOWN'];
                
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('class', 'node');
                g.setAttribute('data-id', node.id);
                g.style.cursor = 'pointer';
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', node.x - 60);
                rect.setAttribute('y', node.y - 20);
                rect.setAttribute('width', 120);
                rect.setAttribute('height', 40);
                rect.setAttribute('rx', 8);
                rect.setAttribute('fill', nodeConfig.color);
                rect.setAttribute('stroke', darkenColor(nodeConfig.color, 20));
                rect.setAttribute('stroke-width', 2);
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', node.x);
                text.setAttribute('y', node.y);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('dominant-baseline', 'middle');
                text.setAttribute('fill', nodeConfig.textColor);
                text.setAttribute('font-size', '12');
                text.setAttribute('font-weight', 'bold');
                text.textContent = node.type;
                
                g.appendChild(rect);
                g.appendChild(text);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                g.addEventListener('click', () => selectNode(node.id));
                
                nodesGroup.appendChild(g);
            });
            
            // è°ƒæ•´SVGè§†å›¾æ¡†
            if (nodes.length > 0) {
                const maxX = Math.max(...nodes.map(n => n.x)) + 100;
                const maxY = Math.max(...nodes.map(n => n.y)) + 50;
                svg.setAttribute('viewBox', `0 0 ${maxX} ${maxY}`);
            }
        }

        // é€‰æ‹©èŠ‚ç‚¹
        function selectNode(nodeId) {
            // æ¸…é™¤é€‰æ‹©
            document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
            document.querySelectorAll('.edge').forEach(e => e.classList.remove('highlighted'));
            
            // é€‰æ‹©æ–°èŠ‚ç‚¹
            const nodeElement = document.querySelector(`[data-id="${nodeId}"]`);
            if (nodeElement) {
                nodeElement.classList.add('selected');
                selectedNode = nodeId;
                
                // é«˜äº®ç›¸å…³è¿çº¿
                document.querySelectorAll(`[data-source="${nodeId}"], [data-target="${nodeId}"]`).forEach(edge => {
                    edge.classList.add('highlighted');
                    edge.setAttribute('marker-end', 'url(#arrowhead-highlight)');
                });
                
                updateStatus(`ğŸ¯ å·²é€‰ä¸­èŠ‚ç‚¹: ${nodeId}`, 'info');
            }
        }

        // åŠ è½½ç¤ºä¾‹æ•°æ®
        function loadSampleData() {
            const sampleData = [
                {
                    "@type": "com.xiaohongshu.data.aimi.workflow.nodes.TemplateTransformNode",
                    "taskId": "PROMPT_BUILD_1",
                    "taskType": "PROMPT_BUILD",
                    "dependencies": []
                },
                {
                    "@type": "com.xiaohongshu.data.aimi.workflow.nodes.LLMNode",
                    "taskId": "CALL_LLM_1", 
                    "taskType": "CALL_LLM",
                    "dependencies": ["PROMPT_BUILD_1"]
                },
                {
                    "@type": "com.xiaohongshu.data.aimi.workflow.nodes.HttpRequestNode",
                    "taskId": "HTTP_REQUEST_1",
                    "taskType": "HTTP_REQUEST", 
                    "dependencies": ["CALL_LLM_1"]
                },
                {
                    "@type": "com.xiaohongshu.data.aimi.workflow.nodes.CodeNode",
                    "taskId": "CODE_EXEC_1",
                    "taskType": "CODE_EXEC",
                    "dependencies": ["HTTP_REQUEST_1"]
                }
            ];
            
            loadDAGData(sampleData, 'sample-data.json');
        }

        // å¯¼å‡ºé…ç½®
        function exportConfig() {
            if (nodes.length === 0) {
                updateStatus('âŒ æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'error');
                return;
            }

            const exportData = nodes.map(node => ({
                '@type': `com.example.${node.type}`,
                'taskId': node.id,
                'taskType': node.type,
                'dependencies': edges.filter(e => e.target === node.id).map(e => e.source),
                'input': [],
                'output': [],
                '_visualization': {
                    'position': { x: node.x, y: node.y },
                    'layout': 'grid',
                    'lastUpdated': new Date().toISOString()
                }
            }));

            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `dag-config-exported-${new Date().getTime()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            updateStatus(`âœ… é…ç½®å·²å¯¼å‡º - ${nodes.length}ä¸ªèŠ‚ç‚¹`, 'success');
        }

        // æ¸…ç©ºç”»å¸ƒ
        function clearCanvas() {
            nodes = [];
            edges = [];
            selectedNode = null;
            
            document.getElementById('nodes-group').innerHTML = '';
            document.getElementById('edges-group').innerHTML = '';
            
            // æ¢å¤é»˜è®¤æç¤º
            const svg = document.getElementById('dag-canvas');
            svg.setAttribute('viewBox', '0 0 1000 500');
            
            const defaultText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            defaultText.setAttribute('x', '500');
            defaultText.setAttribute('y', '250');
            defaultText.setAttribute('text-anchor', 'middle');
            defaultText.setAttribute('fill', '#8c8c8c');
            defaultText.setAttribute('font-size', '18');
            defaultText.textContent = 'è¯·ä¸Šä¼ JSONæ–‡ä»¶å¼€å§‹å¯è§†åŒ–';
            
            document.getElementById('nodes-group').appendChild(defaultText);
            updateStatus('ğŸ—‘ï¸ ç”»å¸ƒå·²æ¸…ç©º', 'info');
        }

        // é¢œè‰²å¤„ç†å·¥å…·å‡½æ•°
        function darkenColor(hex, percent) {
            const num = parseInt(hex.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;
            return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }

        // é¡µé¢åŠ è½½å®Œæˆæç¤º
        console.log(`
ğŸ”— DAGå·¥ä½œæµå¯è§†åŒ–å™¨ - ç‹¬ç«‹ç‰ˆæœ¬

âœ¨ åŠŸèƒ½ç‰¹æ€§ï¼š
â€¢ ğŸ“ æ–‡ä»¶ä¸Šä¼ å’Œæ‹–æ‹½æ”¯æŒ
â€¢ ğŸ¨ å®æ—¶DAGå¯è§†åŒ–æ¸²æŸ“
â€¢ ğŸ¯ èŠ‚ç‚¹é€‰æ‹©å’Œè·¯å¾„é«˜äº®
â€¢ ğŸ’¾ é…ç½®å¯¼å‡ºåŠŸèƒ½
â€¢ ğŸ§ª ç¤ºä¾‹æ•°æ®æµ‹è¯•

ğŸš€ æ— éœ€ä»»ä½•æµè§ˆå™¨æ‰©å±•ï¼Œå¼€ç®±å³ç”¨ï¼
        `);
    </script>
</body>
</html> 