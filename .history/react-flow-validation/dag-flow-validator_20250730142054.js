// React Flow DAG ÂèØËßÜÂåñÈ™åËØÅËÑöÊú¨
// ‰ΩøÁî® CDN ÁâàÊú¨ÁöÑ React Âíå React Flow

const { useState, useCallback, useMemo } = React;
const { ReactFlow, useNodesState, useEdgesState, addEdge, Controls, MiniMap, Background } = ReactFlowCore;

// ÂÖ®Â±ÄÂèòÈáè
let flowInstance = null;
let validationStatus = {
    reactLoaded: false,
    reactFlowLoaded: false,
    renderSuccess: false,
    interactionWorking: false,
    layoutTested: false,
    realDataTested: false
};

// Áä∂ÊÄÅÊõ¥Êñ∞ÂáΩÊï∞
function updateStatus(key, value, message = '') {
    validationStatus[key] = value;
    displayValidationStatus();
    if (message) {
        console.log(`‚úÖ ${message}`);
    }
}

// ÊòæÁ§∫È™åËØÅÁä∂ÊÄÅ
function displayValidationStatus() {
    const container = document.getElementById('status-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    Object.entries(validationStatus).forEach(([key, value]) => {
        const statusItem = document.createElement('div');
        statusItem.className = `status-item ${value ? 'status-success' : 'status-warning'}`;
        
        const labels = {
            reactLoaded: 'React Âä†ËΩΩ',
            reactFlowLoaded: 'React Flow Âä†ËΩΩ',
            renderSuccess: 'Ê∏≤ÊüìÊàêÂäü',
            interactionWorking: '‰∫§‰∫íÂäüËÉΩ',
            layoutTested: 'Â∏ÉÂ±ÄÁÆóÊ≥ï',
            realDataTested: 'ÁúüÂÆûÊï∞ÊçÆ'
        };
        
        statusItem.textContent = `${labels[key]}: ${value ? '‚úÖ' : '‚è≥'}`;
        container.appendChild(statusItem);
    });
}

// Ëá™ÂÆö‰πâËäÇÁÇπÁ±ªÂûã
const customNodeTypes = {
    promptBuild: ({ data }) => {
        return React.createElement('div', {
            style: {
                background: '#52c41a',
                color: 'white',
                padding: '12px',
                borderRadius: '8px',
                border: '2px solid #389e0d',
                fontSize: '12px',
                fontWeight: 'bold',
                textAlign: 'center',
                minWidth: '120px',
                boxShadow: '0 2px 8px rgba(82, 196, 26, 0.3)'
            }
        }, data.label);
    },
    
    callLLM: ({ data }) => {
        return React.createElement('div', {
            style: {
                background: '#faad14',
                color: '#000',
                padding: '12px',
                borderRadius: '8px',
                border: '2px solid #d48806',
                fontSize: '12px',
                fontWeight: 'bold',
                textAlign: 'center',
                minWidth: '120px',
                boxShadow: '0 2px 8px rgba(250, 173, 20, 0.3)'
            }
        }, data.label);
    },
    
    httpRequest: ({ data }) => {
        return React.createElement('div', {
            style: {
                background: '#ff4d4f',
                color: 'white',
                padding: '12px',
                borderRadius: '8px',
                border: '2px solid #cf1322',
                fontSize: '12px',
                fontWeight: 'bold',
                textAlign: 'center',
                minWidth: '120px',
                boxShadow: '0 2px 8px rgba(255, 77, 79, 0.3)'
            }
        }, data.label);
    },
    
    codeExec: ({ data }) => {
        return React.createElement('div', {
            style: {
                background: '#722ed1',
                color: 'white',
                padding: '12px',
                borderRadius: '8px',
                border: '2px solid #531dab',
                fontSize: '12px',
                fontWeight: 'bold',
                textAlign: 'center',
                minWidth: '120px',
                boxShadow: '0 2px 8px rgba(114, 46, 209, 0.3)'
            }
        }, data.label);
    }
};

// DAG Flow ÁªÑ‰ª∂
function DAGFlowComponent() {
    const [nodes, setNodes, onNodesChange] = useNodesState([]);
    const [edges, setEdges, onEdgesChange] = useEdgesState([]);
    
    const onConnect = useCallback((params) => {
        setEdges((eds) => addEdge(params, eds));
    }, [setEdges]);
    
    return React.createElement(ReactFlow, {
        nodes,
        edges,
        onNodesChange,
        onEdgesChange,
        onConnect,
        nodeTypes: customNodeTypes,
        fitView: true,
        style: { width: '100%', height: '100%' },
        onInit: (instance) => {
            flowInstance = instance;
            updateStatus('renderSuccess', true, 'React Flow ÂÆû‰æãÂàùÂßãÂåñÊàêÂäü');
        },
        onNodeClick: (event, node) => {
            console.log('ËäÇÁÇπË¢´ÁÇπÂáª:', node);
            updateStatus('interactionWorking', true, '‰∫§‰∫íÂäüËÉΩÊ≠£Â∏∏');
        }
    }, [
        React.createElement(Controls),
        React.createElement(MiniMap, { nodeColor: '#666' }),
        React.createElement(Background, { variant: 'dots' })
    ]);
}

// ÂàùÂßãÂåñÈ™åËØÅ
function initializeValidation() {
    console.log('üöÄ ÂºÄÂßã React Flow È™åËØÅ...');
    
    // Ê£ÄÊü•‰æùËµñÂ∫ì
    if (typeof React !== 'undefined') {
        updateStatus('reactLoaded', true, 'React Âä†ËΩΩÊàêÂäü');
    } else {
        updateStatus('reactLoaded', false, 'React Âä†ËΩΩÂ§±Ë¥•');
        return;
    }
    
    if (typeof ReactFlowCore !== 'undefined') {
        updateStatus('reactFlowLoaded', true, 'React Flow Âä†ËΩΩÊàêÂäü');
    } else {
        updateStatus('reactFlowLoaded', false, 'React Flow Âä†ËΩΩÂ§±Ë¥•');
        return;
    }
    
    // Ê∏≤Êüì React Flow ÁªÑ‰ª∂
    const container = document.getElementById('dag-flow-container');
    if (container) {
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(DAGFlowComponent));
    }
}

// Âä†ËΩΩÁÆÄÂçï DAG
function loadSimpleDAG() {
    if (!flowInstance) {
        console.error('React Flow ÂÆû‰æãÊú™ÂàùÂßãÂåñ');
        return;
    }
    
    const simpleNodes = [
        {
            id: '1',
            type: 'promptBuild',
            position: { x: 100, y: 100 },
            data: { label: 'PROMPT\nBUILD' }
        },
        {
            id: '2',
            type: 'callLLM',
            position: { x: 300, y: 100 },
            data: { label: 'CALL\nLLM' }
        },
        {
            id: '3',
            type: 'httpRequest',
            position: { x: 500, y: 100 },
            data: { label: 'HTTP\nREQUEST' }
        },
        {
            id: '4',
            type: 'codeExec',
            position: { x: 700, y: 100 },
            data: { label: 'CODE\nEXEC' }
        }
    ];
    
    const simpleEdges = [
        { id: 'e1-2', source: '1', target: '2', animated: true },
        { id: 'e2-3', source: '2', target: '3', animated: true },
        { id: 'e3-4', source: '3', target: '4', animated: true }
    ];
    
    flowInstance.setNodes(simpleNodes);
    flowInstance.setEdges(simpleEdges);
    
    setTimeout(() => {
        flowInstance.fitView();
    }, 100);
    
    console.log('‚úÖ ÁÆÄÂçï DAG Âä†ËΩΩÂÆåÊàê');
}

// Âä†ËΩΩÁúüÂÆûÊï∞ÊçÆ DAGÔºàÊ®°Êãü29‰∏™ËäÇÁÇπÔºâ
function loadRealDAG() {
    if (!flowInstance) {
        console.error('React Flow ÂÆû‰æãÊú™ÂàùÂßãÂåñ');
        return;
    }
    
    // Ê®°ÊãüÁúüÂÆûÁöÑ29‰∏™ËäÇÁÇπÊï∞ÊçÆ
    const realNodes = [
        { id: 'understanding_prompt', type: 'promptBuild', position: { x: 100, y: 50 }, data: { label: 'UNDERSTANDING\nINTENTION\nPROMPT' } },
        { id: 'understanding_llm', type: 'callLLM', position: { x: 100, y: 150 }, data: { label: 'UNDERSTANDING\nINTENTION\nLLM' } },
        { id: 'question_prompt', type: 'promptBuild', position: { x: 100, y: 250 }, data: { label: 'QUESTION\nDECOMPOSE\nPROMPT' } },
        { id: 'question_llm', type: 'callLLM', position: { x: 100, y: 350 }, data: { label: 'QUESTION\nDECOMPOSE\nLLM' } },
        { id: 'field_prompt', type: 'promptBuild', position: { x: 350, y: 200 }, data: { label: 'FIELD\nRETRIEVAL\nPROMPT' } },
        { id: 'field_http', type: 'httpRequest', position: { x: 350, y: 300 }, data: { label: 'FIELD\nRETRIEVAL\nHTTP' } },
        { id: 'field_code', type: 'codeExec', position: { x: 350, y: 400 }, data: { label: 'FIELD\nRETRIEVAL\nCODE' } },
        { id: 'dim_code', type: 'codeExec', position: { x: 350, y: 500 }, data: { label: 'DIM_VALUE\nRETRIEVAL\nCODE' } },
        { id: 'subject_prompt', type: 'promptBuild', position: { x: 600, y: 150 }, data: { label: 'SUBJECT\nFIELD\nPROMPT' } },
        { id: 'subject_llm', type: 'callLLM', position: { x: 600, y: 250 }, data: { label: 'SUBJECT\nFIELD\nLLM' } },
        { id: 'dataset_prompt', type: 'promptBuild', position: { x: 600, y: 350 }, data: { label: 'DATASET\nSELECT\nPROMPT' } },
        { id: 'dataset_http', type: 'httpRequest', position: { x: 600, y: 450 }, data: { label: 'DATASET\nSELECT\nHTTP' } },
        { id: 'dataset_code', type: 'codeExec', position: { x: 600, y: 550 }, data: { label: 'DATASET\nSELECT\nCODE' } },
        { id: 'select_prompt', type: 'promptBuild', position: { x: 850, y: 200 }, data: { label: 'SELECT_ONE\nDATASET\nPROMPT' } },
        { id: 'select_llm', type: 'callLLM', position: { x: 850, y: 300 }, data: { label: 'SELECT_ONE\nDATASET\nLLM' } },
        { id: 'select_code', type: 'codeExec', position: { x: 850, y: 400 }, data: { label: 'SELECT_ONE\nDATASET\nCODE' } },
        { id: 'rerank_prompt', type: 'promptBuild', position: { x: 1100, y: 150 }, data: { label: 'RETRIEVAL\nRERAnK\nPROMPT' } },
        { id: 'rerank_llm', type: 'callLLM', position: { x: 1100, y: 250 }, data: { label: 'RETRIEVAL\nRERAnK\nLLM' } },
        { id: 'rerank_code', type: 'codeExec', position: { x: 1100, y: 350 }, data: { label: 'RETRIEVAL\nRERAnK\nCODE' } },
        { id: 'before_prompt', type: 'promptBuild', position: { x: 1350, y: 100 }, data: { label: 'BEFORE\nCONFIG\nPROMPT' } },
        { id: 'measure_prompt', type: 'promptBuild', position: { x: 1350, y: 200 }, data: { label: 'MEASURE\nRESOLVE\nPROMPT' } },
        { id: 'measure_llm', type: 'callLLM', position: { x: 1350, y: 300 }, data: { label: 'MEASURE\nRESOLVE\nLLM' } },
        { id: 'dimension_prompt', type: 'promptBuild', position: { x: 1350, y: 400 }, data: { label: 'DIMENSION\nRESOLVE\nPROMPT' } },
        { id: 'dimension_llm', type: 'callLLM', position: { x: 1350, y: 500 }, data: { label: 'DIMENSION\nRESOLVE\nLLM' } },
        { id: 'filter_prompt', type: 'promptBuild', position: { x: 1600, y: 200 }, data: { label: 'FILTER\nRESOLVE\nPROMPT' } },
        { id: 'filter_llm', type: 'callLLM', position: { x: 1600, y: 300 }, data: { label: 'FILTER\nRESOLVE\nLLM' } },
        { id: 'analysis_prompt', type: 'promptBuild', position: { x: 1600, y: 400 }, data: { label: 'GEN_ANALYSIS\nPROMPT' } },
        { id: 'analysis_http', type: 'httpRequest', position: { x: 1600, y: 500 }, data: { label: 'GEN_ANALYSIS\nHTTP' } },
        { id: 'evaluate_http', type: 'httpRequest', position: { x: 1850, y: 350 }, data: { label: 'EVALUATE\nSCORE\nHTTP' } },
        { id: 'evaluate_code', type: 'codeExec', position: { x: 1850, y: 450 }, data: { label: 'EVALUATE\nSCORE\nCODE' } }
    ];
    
    const realEdges = [
        { id: 'e1', source: 'understanding_prompt', target: 'understanding_llm' },
        { id: 'e2', source: 'understanding_llm', target: 'question_prompt' },
        { id: 'e3', source: 'question_prompt', target: 'question_llm' },
        { id: 'e4', source: 'question_llm', target: 'field_prompt' },
        { id: 'e5', source: 'field_prompt', target: 'field_http' },
        { id: 'e6', source: 'field_http', target: 'field_code' },
        { id: 'e7', source: 'field_code', target: 'dim_code' },
        { id: 'e8', source: 'field_code', target: 'subject_prompt' },
        { id: 'e9', source: 'subject_prompt', target: 'subject_llm' },
        { id: 'e10', source: 'subject_llm', target: 'dataset_prompt' },
        { id: 'e11', source: 'dataset_prompt', target: 'dataset_http' },
        { id: 'e12', source: 'dataset_http', target: 'dataset_code' },
        { id: 'e13', source: 'dataset_code', target: 'select_prompt' },
        { id: 'e14', source: 'select_prompt', target: 'select_llm' },
        { id: 'e15', source: 'select_llm', target: 'select_code' },
        { id: 'e16', source: 'select_code', target: 'rerank_prompt' },
        { id: 'e17', source: 'rerank_prompt', target: 'rerank_llm' },
        { id: 'e18', source: 'rerank_llm', target: 'rerank_code' },
        { id: 'e19', source: 'rerank_code', target: 'before_prompt' },
        { id: 'e20', source: 'before_prompt', target: 'measure_prompt' },
        { id: 'e21', source: 'measure_prompt', target: 'measure_llm' },
        { id: 'e22', source: 'measure_llm', target: 'dimension_prompt' },
        { id: 'e23', source: 'dimension_prompt', target: 'dimension_llm' },
        { id: 'e24', source: 'dimension_llm', target: 'filter_prompt' },
        { id: 'e25', source: 'filter_prompt', target: 'filter_llm' },
        { id: 'e26', source: 'filter_llm', target: 'analysis_prompt' },
        { id: 'e27', source: 'analysis_prompt', target: 'analysis_http' },
        { id: 'e28', source: 'analysis_http', target: 'evaluate_http' },
        { id: 'e29', source: 'evaluate_http', target: 'evaluate_code' },
        // Âπ∂Ë°åËøûÊé•
        { id: 'e30', source: 'question_llm', target: 'dataset_prompt' },
        { id: 'e31', source: 'field_code', target: 'evaluate_code' }
    ];
    
    flowInstance.setNodes(realNodes);
    flowInstance.setEdges(realEdges);
    
    setTimeout(() => {
        flowInstance.fitView();
    }, 100);
    
    updateStatus('realDataTested', true, 'ÁúüÂÆû DAG Êï∞ÊçÆÔºà29‰∏™ËäÇÁÇπÔºâÂä†ËΩΩÊàêÂäü');
    
    // ÊÄßËÉΩÊµãËØï
    const startTime = performance.now();
    setTimeout(() => {
        const endTime = performance.now();
        console.log(`üìä Ê∏≤ÊüìÊÄßËÉΩÔºö${(endTime - startTime).toFixed(2)}ms`);
    }, 500);
}

// ÊµãËØïÂ∏ÉÂ±ÄÁÆóÊ≥ï
function testLayoutAlgorithms() {
    if (!flowInstance) {
        console.error('React Flow ÂÆû‰æãÊú™ÂàùÂßãÂåñ');
        return;
    }
    
    const nodes = flowInstance.getNodes();
    if (nodes.length === 0) {
        console.warn('ËØ∑ÂÖàÂä†ËΩΩËäÇÁÇπÊï∞ÊçÆ');
        return;
    }
    
    // ÁÆÄÂçïÁöÑËá™Âä®Â∏ÉÂ±ÄÔºàÂ±ÇÊ¨°Â∏ÉÂ±ÄÊ®°ÊãüÔºâ
    const layoutedNodes = nodes.map((node, index) => {
        const row = Math.floor(index / 5);
        const col = index % 5;
        return {
            ...node,
            position: {
                x: col * 200 + 100,
                y: row * 120 + 100
            }
        };
    });
    
    flowInstance.setNodes(layoutedNodes);
    
    setTimeout(() => {
        flowInstance.fitView();
    }, 100);
    
    updateStatus('layoutTested', true, 'Â∏ÉÂ±ÄÁÆóÊ≥ïÊµãËØïÂÆåÊàê');
}

// ÊµãËØï‰∫§‰∫íÂäüËÉΩ
function testInteraction() {
    if (!flowInstance) {
        console.error('React Flow ÂÆû‰æãÊú™ÂàùÂßãÂåñ');
        return;
    }
    
    console.log('üéÆ ‰∫§‰∫íÂäüËÉΩÊµãËØïÔºö');
    console.log('1. ÊãñÊãΩËäÇÁÇπËøõË°åÁßªÂä®');
    console.log('2. ‰ΩøÁî®Èº†Ê†áÊªöËΩÆÁº©Êîæ');
    console.log('3. ÁÇπÂáªËäÇÁÇπÊü•ÁúãÈÄâÊã©ÊïàÊûú');
    console.log('4. ‰ΩøÁî®Âè≥‰∏ãËßíÂ∞èÂú∞ÂõæÂØºËà™');
    
    // Ëá™Âä®ÊµãËØïËäÇÁÇπÈÄâÊã©
    const nodes = flowInstance.getNodes();
    if (nodes.length > 0) {
        const firstNode = nodes[0];
        flowInstance.setNodes(nodes.map(n => ({
            ...n,
            selected: n.id === firstNode.id
        })));
        
        setTimeout(() => {
            flowInstance.setNodes(nodes.map(n => ({
                ...n,
                selected: false
            })));
        }, 2000);
        
        updateStatus('interactionWorking', true, 'Ëá™Âä®ÈÄâÊã©ÊµãËØïÂÆåÊàê');
    }
}

// Ê∏ÖÁ©∫ÁîªÂ∏É
function clearFlow() {
    if (!flowInstance) {
        console.error('React Flow ÂÆû‰æãÊú™ÂàùÂßãÂåñ');
        return;
    }
    
    flowInstance.setNodes([]);
    flowInstance.setEdges([]);
    console.log('üßπ ÁîªÂ∏ÉÂ∑≤Ê∏ÖÁ©∫');
}

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÂºÄÂßãÈ™åËØÅ...');
    
    // Á®çÂæÆÂª∂ËøüÁ°Æ‰øùÊâÄÊúâ CDN ËµÑÊ∫êÂä†ËΩΩÂÆåÊàê
    setTimeout(() => {
        initializeValidation();
        displayValidationStatus();
    }, 500);
}); 