# 📋 Level 3 任务：DAG 可视化浏览器插件

## 🎯 任务描述
开发一个浏览器插件或油猴脚本，实现基于 JSON 配置的 DAG 工作流可视化渲染，专注于节点关系和依赖展示。

## 📊 复杂度级别
**Level 3: Intermediate Feature** 
- 需要多组件协作
- 需要技术选型决策
- 预计开发周期：1-2周

## 📋 详细需求分析

### 功能需求
1. **JSON 解析模块**
   - 解析 dag-question-rewrite-rerank.json 文件
   - 提取节点信息（taskId, @type, taskType）
   - 解析依赖关系（dependencies 数组）
   - 忽略详细的 input/output 内容

2. **可视化渲染模块**
   - 图形化展示 29 个工作流节点
   - 根据节点类型使用不同颜色/形状：
     - TemplateTransformNode (PROMPT_BUILD) - 绿色
     - LLMNode (CALL_LLM) - 黄色
     - HttpRequestNode (HTTP_REQUEST) - 红色
     - CodeNode (EXEC_CODE) - 紫色
   - 绘制节点间依赖关系连线
   - 自动布局算法优化节点位置

3. **交互功能模块**
   - 节点悬停显示基本信息
   - 点击节点高亮依赖路径
   - 拖拽移动节点位置
   - 缩放和平移画布

4. **配置互转功能**
   - 从 JSON 配置生成可视化
   - 基础的画布到配置导出（节点位置信息）

### 非功能需求
- 浏览器兼容性：Chrome, Firefox, Safari
- 响应式设计，适配不同屏幕尺寸
- 流畅的用户交互体验
- 轻量级，加载速度快

## 🏗️ 组件分析

### 新建组件
1. **JSON 解析器 (JsonParser)**
   - 负责：解析 DAG JSON 配置
   - 依赖：无外部依赖
   - 输出：React Flow 兼容的节点和边数据结构

2. **React Flow 渲染器 (FlowRenderer)**
   - 负责：基于 React Flow 的图形渲染
   - 依赖：React Flow 库
   - 输出：可视化的 DAG 组件

3. **自定义节点组件 (CustomNodes)**
   - 负责：不同类型节点的样式和行为
   - 依赖：React 组件系统
   - 输出：样式化的节点组件

4. **交互控制器 (InteractionController)**
   - 负责：用户交互处理
   - 依赖：React Flow 事件系统
   - 输出：交互响应和状态更新

5. **插件接口 (PluginInterface)**
   - 负责：浏览器插件/油猴脚本接口
   - 依赖：浏览器 API
   - 输出：插件功能集成

### 受影响的外部组件
- 目标网页 DOM（如果是内容脚本）
- 浏览器扩展 API（如果是插件）
- 用户脚本管理器（如果是油猴脚本）

## 🔧 技术栈重新选择

### 🔄 **调整后的技术栈：**
- **核心语言**: 原生 JavaScript (ES6+)
- **图形库**: **SVG + CSS** 或 **HTML5 Canvas** (待确定)
- **构建工具**: 无需构建工具 (直接开发)
- **包管理器**: 无依赖 (或仅基础工具库)
- **部署方式**: 油猴脚本优先

### 🚫 **React Flow 决策调整：**
❌ **放弃原因** - 用户反馈"增加了复杂度，暂不耗时集成"  
❌ **过度复杂** - 对于基础可视化需求来说太重  
❌ **学习成本** - 增加不必要的开发复杂度  
❌ **依赖过重** - React + React Flow + 相关生态  

### ✅ **简化方案优势：**
✅ **轻量级** - 没有重型依赖  
✅ **快速开发** - 直接使用原生 API  
✅ **易维护** - 代码简单直观  
✅ **部署简单** - 单文件即可运行  

## 📈 实施策略

### 第一阶段：核心功能重新规划 🔄 **需要重新验证**
1. **JSON 解析器实现**
   - 创建解析函数 ✅ 已完成（可复用）
   - 数据结构设计 🔄 需要调整为原生格式
   - 单元测试 🔄 需要重新验证

2. **基础图形渲染**
   - 选择图形库 🔄 重新选择：SVG/Canvas
   - 节点绘制 ⏳ 待重新实现
   - 连线绘制 ⏳ 待重新实现

### 第二阶段：简化交互功能
1. **基础交互**
   - 悬停效果 ⏳ 重新设计
   - 点击选择 ⏳ 原生事件处理
   - 基础拖拽 ⏳ 可选功能

2. **布局优化**
   - 简单布局算法 ⏳ 网格或层次布局
   - 基础视觉优化 ⏳ CSS 样式

### 第三阶段：插件集成
1. **插件架构**
   - 选择部署方式 🎨 需要创意阶段决策
   - 权限配置 ⏳ 待设计
   - 安装流程 ⏳ 待设计

2. **配置互转**
   - 导出功能 ⏳ 待实现
   - 位置保存 ⏳ 待实现
   - 格式转换 ⏳ 待实现

## ⚠️ 依赖和风险

### 技术依赖
- 图形可视化库选择 ✅ 已解决 - React Flow
- 浏览器兼容性 ✅ React Flow 兼容性良好
- CDN 可用性 ✅ unpkg.com 稳定可用

### 风险评估
- **原高风险**: 图形库性能问题 → **已解决** - React Flow 表现优秀
- **中风险**: 浏览器权限限制 ⏳ 待评估
- **低风险**: JSON 解析复杂性 ✅ 已解决

### 缓解策略
- 提前进行图形库性能测试 ✅ 已完成 - React Flow
- 准备多种部署方案（插件/油猴）
- 简化初始功能范围

## ✅ 创意阶段完成的组件

### 已完成的创意设计决策：
- [x] **技术架构决策**: ✅ 油猴脚本优先部署（高优先级）
- [x] **UI/UX 设计**: ✅ 极简工具面板 + 全屏画布（中优先级）
- [x] **布局算法选择**: ✅ 分层布局 (Hierarchical Layout)（低优先级）
- [x] **配置导出功能**: ✅ 简化配置增强方案（高优先级）

## 📊 技术验证检查点

### ✅ **轻量化技术验证完成：**
- [x] **JSON 解析验证** - 29节点数据解析成功（可复用）
- [x] **SVG 渲染验证** ✅ - 基础绘制能力验证通过
- [x] **原生交互验证** ✅ - DOM 事件处理验证通过
- [x] **布局算法验证** ✅ - 层次布局和网格布局实现
- [x] **真实数据验证** ✅ - 支持加载真实 JSON 文件
- [x] **浏览器兼容性** ✅ - 原生方案兼容性良好

### 🚫 **已放弃的 React Flow 验证：**
- ~~React Flow CDN 加载~~ - 决策放弃，过于复杂
- ~~React 集成~~ - 决策放弃，增加复杂度
- ~~复杂交互功能~~ - 决策放弃，超出需求范围
- ~~自动布局算法~~ - 决策放弃，使用简单方案

### ✅ **轻量化验证成果：**
- **验证文件**: `native-validation/lightweight-dag.html` - 基础验证
- **真实数据验证**: `native-validation/real-data-test.html` - 真实JSON支持
- **验证结果**: ✅ 轻量级、快速、易维护的解决方案验证通过
- **技术特性**: 零依赖、4KB代码、原生渲染、完整交互

## 📝 任务状态
- [x] VAN 模式初始化完成
- [x] 复杂度评估完成 (Level 3)
- [x] PLAN 模式详细规划完成
- [x] **技术验证调整** ✅ **轻量化技术栈确定**
- [x] **轻量化技术验证** ✅ **原生 JavaScript + SVG 验证通过**
- [x] **创意阶段完成** ✅ **四个核心决策全部完成**
- [ ] **实施阶段待开始** 🎯 **下一阶段目标**
- [ ] 测试验证待开始
- [ ] 反思归档待开始

## ✅ 验证完成
1. **轻量化验证成功** ✅ - 原生 JavaScript + SVG 方案验证通过
2. **真实数据支持** ✅ - 支持加载和解析真实 JSON 文件
3. **技术栈确定** ✅ - 零依赖、完全原生的解决方案

## 🎊 创意阶段圆满完成
所有核心设计决策已完成，技术架构清晰，准备进入代码实施阶段。

### 📋 创意成果汇总
1. **技术架构**：油猴脚本优先部署
2. **UI/UX设计**：极简工具面板 + 全屏画布，严格遵循样式指南
3. **布局算法**：分层布局算法，最适合DAG特性
4. **配置导出功能**：简化配置增强方案，input/output置空，专注DAG结构

## 🚀 下一阶段：IMPLEMENT
根据创意决策开始代码实现，包括：

### 📋 实施阶段主要任务
1. **油猴脚本架构搭建**
   - 创建用户脚本框架(.user.js)
   - 设置权限和匹配规则
   - 实现页面注入和DOM操作

2. **SVG渲染引擎实现**
   - 基于验证代码进行模块化重构
   - 实现节点渲染类和连线绘制类
   - 严格按照样式指南实现视觉效果

3. **分层布局算法编码**
   - 实现拓扑排序和层级计算
   - 节点位置自动计算和碰撞检测
   - 支持手动拖拽和位置保存

4. **文件操作和配置导出功能**
   - 实现拖拽上传和文件读取
   - 配置简化处理(input/output置空)
   - 位置信息扩展和导出下载

---
*最后更新: 创意阶段完成* 