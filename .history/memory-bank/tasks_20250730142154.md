# 📋 Level 3 任务：DAG 可视化浏览器插件

## 🎯 任务描述
开发一个浏览器插件或油猴脚本，实现基于 JSON 配置的 DAG 工作流可视化渲染，专注于节点关系和依赖展示。

## 📊 复杂度级别
**Level 3: Intermediate Feature** 
- 需要多组件协作
- 需要技术选型决策
- 预计开发周期：1-2周

## 📋 详细需求分析

### 功能需求
1. **JSON 解析模块**
   - 解析 dag-question-rewrite-rerank.json 文件
   - 提取节点信息（taskId, @type, taskType）
   - 解析依赖关系（dependencies 数组）
   - 忽略详细的 input/output 内容

2. **可视化渲染模块**
   - 图形化展示 29 个工作流节点
   - 根据节点类型使用不同颜色/形状：
     - TemplateTransformNode (PROMPT_BUILD)
     - LLMNode (CALL_LLM)
     - HttpRequestNode (HTTP_REQUEST)
     - CodeNode (EXEC_CODE)
   - 绘制节点间依赖关系连线
   - 自动布局算法优化节点位置

3. **交互功能模块**
   - 节点悬停显示基本信息
   - 点击节点高亮依赖路径
   - 拖拽移动节点位置
   - 缩放和平移画布

4. **配置互转功能**
   - 从 JSON 配置生成可视化
   - 基础的画布到配置导出（节点位置信息）

### 非功能需求
- 浏览器兼容性：Chrome, Firefox, Safari
- 响应式设计，适配不同屏幕尺寸
- 流畅的用户交互体验
- 轻量级，加载速度快

## 🏗️ 组件分析

### 新建组件
1. **JSON 解析器 (JsonParser)**
   - 负责：解析 DAG JSON 配置
   - 依赖：无外部依赖
   - 输出：标准化的节点和边数据结构

2. **图形渲染引擎 (GraphRenderer)**
   - 负责：SVG/Canvas 图形绘制
   - 依赖：选定的图形库
   - 输出：可视化的 DAG 图形

3. **布局算法 (LayoutEngine)**
   - 负责：节点自动布局
   - 依赖：图形算法库
   - 输出：优化的节点坐标

4. **交互控制器 (InteractionController)**
   - 负责：用户交互处理
   - 依赖：DOM 事件、图形渲染引擎
   - 输出：交互响应和状态更新

5. **插件接口 (PluginInterface)**
   - 负责：浏览器插件/油猴脚本接口
   - 依赖：浏览器 API
   - 输出：插件功能集成

### 受影响的外部组件
- 目标网页 DOM（如果是内容脚本）
- 浏览器扩展 API（如果是插件）
- 用户脚本管理器（如果是油猴脚本）

## 🔧 技术栈选择

### 已确定的技术栈：
- **语言**: JavaScript (ES6+)
- **图形库**: Cytoscape.js ✅ 已验证
- **构建工具**: Rollup (轻量级，适合库构建)
- **包管理器**: npm ✅ 已验证
- **部署方式**: 优先考虑油猴脚本（开发简单，部署便捷）

### 技术验证结果：
✅ **Cytoscape.js v3.33.0** 安装成功
✅ **基础图形渲染** 功能验证通过
✅ **JSON 解析器** 开发完成并测试
✅ **节点样式和交互** 验证通过

## 📈 实施策略

### 第一阶段：核心功能开发
1. **JSON 解析器实现**
   - 创建解析函数 ✅ 已完成
   - 数据结构设计 ✅ 已完成
   - 单元测试 ✅ 已完成

2. **基础图形渲染**
   - 选择图形库 ✅ Cytoscape.js
   - 节点绘制 ✅ 已验证
   - 连线绘制 ✅ 已验证

### 第二阶段：交互功能
1. **用户交互**
   - 悬停效果 ✅ 已实现
   - 点击选择 ✅ 已实现
   - 拖拽支持 ⏳ 待实现

2. **布局优化**
   - 自动布局算法 ✅ breadthfirst 已验证
   - 碰撞检测 ⏳ 待验证
   - 视觉优化 ⏳ 待优化

### 第三阶段：插件集成
1. **插件架构**
   - 选择部署方式 🎨 需要创意阶段决策
   - 权限配置 ⏳ 待设计
   - 安装流程 ⏳ 待设计

2. **配置互转**
   - 导出功能 ⏳ 待实现
   - 位置保存 ⏳ 待实现
   - 格式转换 ⏳ 待实现

## ⚠️ 依赖和风险

### 技术依赖
- 图形可视化库选择 ✅ 已解决 - Cytoscape.js
- 浏览器兼容性 ✅ 验证中
- 插件 API 限制 ⏳ 待评估

### 风险评估
- **高风险**: 图形库性能问题（29个节点 + 连线） → **降为中风险** - 测试显示性能良好
- **中风险**: 浏览器权限限制
- **低风险**: JSON 解析复杂性 ✅ 已解决

### 缓解策略
- 提前进行图形库性能测试 ✅ 已完成
- 准备多种部署方案（插件/油猴）
- 简化初始功能范围

## 🎨 需要创意阶段的组件

### 标记为需要创意设计的部分：
- [ ] **技术架构决策**: 浏览器插件 vs 油猴脚本（高优先级）
- [ ] **UI/UX 设计**: 节点样式、颜色方案、交互模式（中优先级）
- [ ] **布局算法选择**: 层次布局 vs 力导向布局（低优先级）

## 📊 技术验证检查点

### ✅ 已验证项目：
- [x] **Cytoscape.js Hello World** - 成功渲染基础图形
- [x] **JSON 解析功能** - 完整的解析器开发完成
- [x] **基本节点渲染** - 4种节点类型样式验证
- [x] **基础交互功能** - 点击、悬停、高亮功能
- [x] **依赖项安装** - npm 项目结构正常
- [x] **本地测试环境** - HTTP 服务器运行正常

### 🔧 技术验证服务器状态：
- **地址**: http://localhost:8080
- **状态**: 运行中
- **测试文件**: index.html, dag-validator.js, dag-parser.js

## 📝 任务状态
- [x] VAN 模式初始化完成
- [x] 复杂度评估完成 (Level 3)
- [x] PLAN 模式详细规划完成
- [x] **技术验证完成** ✅
- [ ] 创意阶段待开始
- [ ] 实施阶段待开始
- [ ] 测试验证待开始
- [ ] 反思归档待开始

---
*最后更新: PLAN 模式技术验证完成* 