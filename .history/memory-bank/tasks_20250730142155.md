# 📋 Level 3 任务：DAG 可视化浏览器插件

## 🎯 任务描述
开发一个浏览器插件或油猴脚本，实现基于 JSON 配置的 DAG 工作流可视化渲染，专注于节点关系和依赖展示。

## 📊 复杂度级别
**Level 3: Intermediate Feature** 
- 需要多组件协作
- 需要技术选型决策
- 预计开发周期：1-2周

## 📋 详细需求分析

### 功能需求
1. **JSON 解析模块**
   - 解析 dag-question-rewrite-rerank.json 文件
   - 提取节点信息（taskId, @type, taskType）
   - 解析依赖关系（dependencies 数组）
   - 忽略详细的 input/output 内容

2. **可视化渲染模块**
   - 图形化展示 29 个工作流节点
   - 根据节点类型使用不同颜色/形状：
     - TemplateTransformNode (PROMPT_BUILD) - 绿色
     - LLMNode (CALL_LLM) - 黄色
     - HttpRequestNode (HTTP_REQUEST) - 红色
     - CodeNode (EXEC_CODE) - 紫色
   - 绘制节点间依赖关系连线
   - 自动布局算法优化节点位置

3. **交互功能模块**
   - 节点悬停显示基本信息
   - 点击节点高亮依赖路径
   - 拖拽移动节点位置
   - 缩放和平移画布

4. **配置互转功能**
   - 从 JSON 配置生成可视化
   - 基础的画布到配置导出（节点位置信息）

### 非功能需求
- 浏览器兼容性：Chrome, Firefox, Safari
- 响应式设计，适配不同屏幕尺寸
- 流畅的用户交互体验
- 轻量级，加载速度快

## 🏗️ 组件分析

### 新建组件
1. **JSON 解析器 (JsonParser)**
   - 负责：解析 DAG JSON 配置
   - 依赖：无外部依赖
   - 输出：React Flow 兼容的节点和边数据结构

2. **React Flow 渲染器 (FlowRenderer)**
   - 负责：基于 React Flow 的图形渲染
   - 依赖：React Flow 库
   - 输出：可视化的 DAG 组件

3. **自定义节点组件 (CustomNodes)**
   - 负责：不同类型节点的样式和行为
   - 依赖：React 组件系统
   - 输出：样式化的节点组件

4. **交互控制器 (InteractionController)**
   - 负责：用户交互处理
   - 依赖：React Flow 事件系统
   - 输出：交互响应和状态更新

5. **插件接口 (PluginInterface)**
   - 负责：浏览器插件/油猴脚本接口
   - 依赖：浏览器 API
   - 输出：插件功能集成

### 受影响的外部组件
- 目标网页 DOM（如果是内容脚本）
- 浏览器扩展 API（如果是插件）
- 用户脚本管理器（如果是油猴脚本）

## 🔧 技术栈选择

### ✅ **确定的技术栈：**
- **核心语言**: JavaScript (ES6+) + React
- **图形库**: **React Flow** ✅ (替代 Cytoscape.js)
- **构建工具**: Vite (更快的开发体验)
- **包管理器**: npm
- **部署方式**: 优先考虑油猴脚本（开发简单，部署便捷）

### 🚀 **React Flow 优势验证：**
✅ **专为流程图设计** - 原生 DAG 支持，内置布局算法  
✅ **React 原生集成** - 节点可以是任意 React 组件  
✅ **丰富的内置功能** - 拖拽、缩放、minimap、控制器  
✅ **性能优化** - 虚拟化渲染，29个节点性能表现良好  
✅ **强大的自定义能力** - 节点、边、事件完全可定制  

## 📈 实施策略

### 第一阶段：核心功能开发 ✅ **技术验证完成**
1. **JSON 解析器实现**
   - 创建解析函数 ✅ 已完成
   - 数据结构设计 ✅ React Flow 格式
   - 单元测试 ✅ 29节点测试通过

2. **基础图形渲染**
   - 选择图形库 ✅ React Flow (CDN)
   - 节点绘制 ✅ 4种类型节点验证
   - 连线绘制 ✅ 动画连线验证

### 第二阶段：交互功能
1. **用户交互**
   - 悬停效果 ✅ 已实现
   - 点击选择 ✅ 已实现
   - 拖拽支持 ✅ React Flow 内置

2. **布局优化**
   - 自动布局算法 ✅ 多种布局验证
   - 碰撞检测 ✅ React Flow 内置
   - 视觉优化 ✅ 自定义节点样式

### 第三阶段：插件集成
1. **插件架构**
   - 选择部署方式 🎨 需要创意阶段决策
   - 权限配置 ⏳ 待设计
   - 安装流程 ⏳ 待设计

2. **配置互转**
   - 导出功能 ⏳ 待实现
   - 位置保存 ⏳ 待实现
   - 格式转换 ⏳ 待实现

## ⚠️ 依赖和风险

### 技术依赖
- 图形可视化库选择 ✅ 已解决 - React Flow
- 浏览器兼容性 ✅ React Flow 兼容性良好
- CDN 可用性 ✅ unpkg.com 稳定可用

### 风险评估
- **原高风险**: 图形库性能问题 → **已解决** - React Flow 表现优秀
- **中风险**: 浏览器权限限制 ⏳ 待评估
- **低风险**: JSON 解析复杂性 ✅ 已解决

### 缓解策略
- 提前进行图形库性能测试 ✅ 已完成 - React Flow
- 准备多种部署方案（插件/油猴）
- 简化初始功能范围

## 🎨 需要创意阶段的组件

### 标记为需要创意设计的部分：
- [ ] **技术架构决策**: 浏览器插件 vs 油猴脚本（高优先级）
- [ ] **UI/UX 设计**: 节点样式、颜色方案、交互模式（中优先级）
- [ ] **布局算法选择**: 分层布局 vs 网格布局（低优先级 - 基础算法已验证）

## 📊 技术验证检查点

### ✅ **已验证项目（React Flow）：**
- [x] **React Flow CDN 加载** - 通过 unpkg.com 正确加载
- [x] **React 集成** - React 18 + React Flow 完美集成
- [x] **29节点真实数据** - 完整的DAG结构渲染
- [x] **4种节点类型** - 样式差异化显示
- [x] **交互功能** - 拖拽、缩放、选择、minimap
- [x] **布局算法** - 自动布局和手动布局
- [x] **性能表现** - 流畅的渲染和交互
- [x] **浏览器环境** - 无需本地服务器直接运行

### 🔧 **正确的技术验证方法：**
- **验证文件**: `react-flow-validation/browser-validation.html`
- **运行方式**: 直接在浏览器中打开，无需服务器
- **验证范围**: React Flow + 真实数据 + 完整交互
- **结果**: 所有功能验证通过 ✅

### ❌ **已废弃的错误验证：**
- ~~Cytoscape.js~~ - 替换为 React Flow
- ~~localhost:8080~~ - 删除无用的本地服务器
- ~~npm 项目~~ - 改为 CDN 直接加载

## 📝 任务状态
- [x] VAN 模式初始化完成
- [x] 复杂度评估完成 (Level 3)
- [x] PLAN 模式详细规划完成
- [x] **技术验证完成** ✅ **React Flow 验证通过**
- [ ] 创意阶段待开始
- [ ] 实施阶段待开始
- [ ] 测试验证待开始
- [ ] 反思归档待开始

---
*最后更新: React Flow 技术验证完成* 