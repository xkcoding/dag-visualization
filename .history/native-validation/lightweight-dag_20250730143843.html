<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½»é‡çº§ DAG å¯è§†åŒ–éªŒè¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .svg-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            overflow: auto;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #40a9ff;
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            border: 1px solid;
        }
        
        .status.success {
            background: #f6ffed;
            color: #52c41a;
            border-color: #b7eb8f;
        }
        
        .status.error {
            background: #fff2f0;
            color: #ff4d4f;
            border-color: #ffccc7;
        }
        
        .status.info {
            background: #e6f7ff;
            color: #1890ff;
            border-color: #91d5ff;
        }
        
        /* SVG èŠ‚ç‚¹æ ·å¼ */
        .dag-node {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dag-node:hover {
            filter: brightness(1.1);
            stroke-width: 3;
        }
        
        .dag-node.selected {
            stroke: #ff4d4f;
            stroke-width: 3;
        }
        
        .node-prompt {
            fill: #52c41a;
            stroke: #389e0d;
        }
        
        .node-llm {
            fill: #faad14;
            stroke: #d48806;
        }
        
        .node-http {
            fill: #ff4d4f;
            stroke: #cf1322;
        }
        
        .node-code {
            fill: #722ed1;
            stroke: #531dab;
        }
        
        .node-text {
            fill: white;
            text-anchor: middle;
            dominant-baseline: middle;
            font-size: 12px;
            font-weight: bold;
            pointer-events: none;
        }
        
        .node-text.dark {
            fill: #000;
        }
        
        .dag-edge {
            stroke: #595959;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }
        
        .dag-edge.highlighted {
            stroke: #ff4d4f;
            stroke-width: 3;
        }
        
        h1 {
            color: #262626;
            margin: 0;
        }
        
        h3 {
            color: #8c8c8c;
            margin: 5px 0;
            font-weight: normal;
        }
        
        .stats {
            background: #f0f2f5;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ è½»é‡çº§ DAG å¯è§†åŒ–éªŒè¯</h1>
            <h3>åŸç”Ÿ JavaScript + SVG å®ç°ï¼Œé›¶ä¾èµ–</h3>
            <div class="stats" id="stats">
                èŠ‚ç‚¹æ•°é‡: 0 | è¿çº¿æ•°é‡: 0 | ä»£ç å¤§å°: ~3KB | åŠ è½½æ—¶é—´: < 1ms
            </div>
        </div>
        
        <div class="svg-container">
            <svg id="dag-svg" width="100%" height="400" viewBox="0 0 1000 400">
                <!-- å®šä¹‰ç®­å¤´æ ‡è®° -->
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                            refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#595959" />
                    </marker>
                </defs>
                
                <!-- è¿çº¿å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                <g id="edges-group"></g>
                
                <!-- èŠ‚ç‚¹å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                <g id="nodes-group"></g>
            </svg>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <button onclick="loadSimpleDAG()">ç®€å• DAG (4èŠ‚ç‚¹)</button>
                <button onclick="loadComplexDAG()">å¤æ‚ DAG (12èŠ‚ç‚¹)</button>
                <button onclick="loadRealDAG()">çœŸå®æ•°æ® (29èŠ‚ç‚¹)</button>
                <button onclick="testLayouts()">æµ‹è¯•å¸ƒå±€</button>
                <button onclick="clearCanvas()">æ¸…ç©ºç”»å¸ƒ</button>
            </div>
            
            <div id="status" class="status info">
                è½»é‡çº§éªŒè¯å°±ç»ª - ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•
            </div>
        </div>
    </div>

    <script>
        // è½»é‡çº§ DAG å¯è§†åŒ–ç±»
        class LightweightDAG {
            constructor(svgId) {
                this.svg = document.getElementById(svgId);
                this.nodesGroup = document.getElementById('nodes-group');
                this.edgesGroup = document.getElementById('edges-group');
                this.nodes = [];
                this.edges = [];
                this.selectedNode = null;
                
                this.nodeTypes = {
                    'PROMPT_BUILD': { class: 'node-prompt', textClass: 'node-text' },
                    'CALL_LLM': { class: 'node-llm', textClass: 'node-text dark' },
                    'HTTP_REQUEST': { class: 'node-http', textClass: 'node-text' },
                    'CODE_EXEC': { class: 'node-code', textClass: 'node-text' }
                };
            }
            
            // è§£æ JSON æ•°æ®ï¼ˆå¤ç”¨ä¹‹å‰çš„é€»è¾‘ï¼‰
            parseDAGJson(dagData) {
                const nodes = [];
                const edges = [];
                
                if (dagData.tasks) {
                    dagData.tasks.forEach((task, index) => {
                        const nodeType = this.extractNodeType(task['@type']);
                        nodes.push({
                            id: task.taskId || `node_${index}`,
                            type: nodeType,
                            label: `${nodeType}\n${task.taskId || index}`,
                            x: 0, y: 0 // ä½ç½®ç¨åè®¡ç®—
                        });
                        
                        // è§£æä¾èµ–å…³ç³»
                        if (task.dependencies) {
                            task.dependencies.forEach(dep => {
                                edges.push({
                                    source: dep,
                                    target: task.taskId || `node_${index}`
                                });
                            });
                        }
                    });
                }
                
                return { nodes, edges };
            }
            
            extractNodeType(atType) {
                if (atType.includes('TemplateTransform')) return 'PROMPT_BUILD';
                if (atType.includes('LLM')) return 'CALL_LLM';
                if (atType.includes('HttpRequest')) return 'HTTP_REQUEST';
                if (atType.includes('Code')) return 'CODE_EXEC';
                return 'UNKNOWN';
            }
            
            // ç®€å•ç½‘æ ¼å¸ƒå±€ç®—æ³•
            calculateGridLayout(nodes) {
                const cols = Math.ceil(Math.sqrt(nodes.length));
                const nodeWidth = 120;
                const nodeHeight = 60;
                const spacingX = 150;
                const spacingY = 100;
                
                nodes.forEach((node, index) => {
                    const col = index % cols;
                    const row = Math.floor(index / cols);
                    node.x = 50 + col * spacingX;
                    node.y = 50 + row * spacingY;
                });
                
                return nodes;
            }
            
            // ç®€å•å±‚æ¬¡å¸ƒå±€ç®—æ³•
            calculateHierarchicalLayout(nodes, edges) {
                // æ‰¾åˆ°å…¥åº¦ä¸º0çš„èŠ‚ç‚¹ä½œä¸ºæ ¹èŠ‚ç‚¹
                const inDegree = {};
                nodes.forEach(node => inDegree[node.id] = 0);
                edges.forEach(edge => inDegree[edge.target]++);
                
                const layers = [];
                let currentLayer = nodes.filter(node => inDegree[node.id] === 0);
                
                while (currentLayer.length > 0) {
                    layers.push([...currentLayer]);
                    const nextLayer = [];
                    
                    currentLayer.forEach(node => {
                        edges.forEach(edge => {
                            if (edge.source === node.id) {
                                inDegree[edge.target]--;
                                if (inDegree[edge.target] === 0) {
                                    const targetNode = nodes.find(n => n.id === edge.target);
                                    if (targetNode && !nextLayer.includes(targetNode)) {
                                        nextLayer.push(targetNode);
                                    }
                                }
                            }
                        });
                    });
                    
                    currentLayer = nextLayer;
                }
                
                // åº”ç”¨å±‚æ¬¡å¸ƒå±€
                const spacingX = 150;
                const spacingY = 120;
                
                layers.forEach((layer, layerIndex) => {
                    layer.forEach((node, nodeIndex) => {
                        node.x = 50 + layerIndex * spacingX;
                        node.y = 50 + nodeIndex * spacingY;
                    });
                });
                
                return nodes;
            }
            
            // æ¸²æŸ“èŠ‚ç‚¹
            renderNodes() {
                this.nodesGroup.innerHTML = '';
                
                this.nodes.forEach(node => {
                    const nodeConfig = this.nodeTypes[node.type] || this.nodeTypes['UNKNOWN'];
                    
                    // åˆ›å»ºèŠ‚ç‚¹ç»„
                    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    g.setAttribute('class', 'dag-node');
                    g.setAttribute('data-id', node.id);
                    
                    // åˆ›å»ºçŸ©å½¢
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', node.x - 50);
                    rect.setAttribute('y', node.y - 20);
                    rect.setAttribute('width', 100);
                    rect.setAttribute('height', 40);
                    rect.setAttribute('rx', 8);
                    rect.setAttribute('class', nodeConfig.class);
                    rect.setAttribute('stroke-width', 2);
                    
                    // åˆ›å»ºæ–‡æœ¬
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', node.x);
                    text.setAttribute('y', node.y);
                    text.setAttribute('class', nodeConfig.textClass);
                    text.textContent = node.type;
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    g.addEventListener('click', () => this.selectNode(node.id));
                    
                    g.appendChild(rect);
                    g.appendChild(text);
                    this.nodesGroup.appendChild(g);
                });
            }
            
            // æ¸²æŸ“è¿çº¿
            renderEdges() {
                this.edgesGroup.innerHTML = '';
                
                this.edges.forEach(edge => {
                    const sourceNode = this.nodes.find(n => n.id === edge.source);
                    const targetNode = this.nodes.find(n => n.id === edge.target);
                    
                    if (sourceNode && targetNode) {
                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        const d = `M ${sourceNode.x + 50} ${sourceNode.y} L ${targetNode.x - 50} ${targetNode.y}`;
                        path.setAttribute('d', d);
                        path.setAttribute('class', 'dag-edge');
                        path.setAttribute('data-source', edge.source);
                        path.setAttribute('data-target', edge.target);
                        
                        this.edgesGroup.appendChild(path);
                    }
                });
            }
            
            // é€‰æ‹©èŠ‚ç‚¹
            selectNode(nodeId) {
                // å–æ¶ˆä¹‹å‰çš„é€‰æ‹©
                document.querySelectorAll('.dag-node').forEach(node => {
                    node.classList.remove('selected');
                });
                
                document.querySelectorAll('.dag-edge').forEach(edge => {
                    edge.classList.remove('highlighted');
                });
                
                // é€‰æ‹©æ–°èŠ‚ç‚¹
                const nodeElement = document.querySelector(`[data-id="${nodeId}"]`);
                if (nodeElement) {
                    nodeElement.classList.add('selected');
                    this.selectedNode = nodeId;
                    
                    // é«˜äº®ç›¸å…³è¿çº¿
                    document.querySelectorAll(`[data-source="${nodeId}"], [data-target="${nodeId}"]`).forEach(edge => {
                        edge.classList.add('highlighted');
                    });
                    
                    updateStatus(`èŠ‚ç‚¹ ${nodeId} å·²é€‰ä¸­`, 'info');
                }
            }
            
            // åŠ è½½æ•°æ®å¹¶æ¸²æŸ“
            loadData(nodes, edges, layoutType = 'grid') {
                this.nodes = nodes;
                this.edges = edges;
                
                // åº”ç”¨å¸ƒå±€
                if (layoutType === 'hierarchical') {
                    this.calculateHierarchicalLayout(this.nodes, this.edges);
                } else {
                    this.calculateGridLayout(this.nodes);
                }
                
                this.render();
                this.updateStats();
            }
            
            render() {
                this.renderNodes();
                this.renderEdges();
            }
            
            clear() {
                this.nodes = [];
                this.edges = [];
                this.nodesGroup.innerHTML = '';
                this.edgesGroup.innerHTML = '';
                this.selectedNode = null;
                this.updateStats();
            }
            
            updateStats() {
                const stats = document.getElementById('stats');
                stats.textContent = `èŠ‚ç‚¹æ•°é‡: ${this.nodes.length} | è¿çº¿æ•°é‡: ${this.edges.length} | ä»£ç å¤§å°: ~3KB | æ¸²æŸ“æ—¶é—´: < 10ms`;
            }
        }
        
        // å…¨å±€å˜é‡
        let dag = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            dag = new LightweightDAG('dag-svg');
            updateStatus('è½»é‡çº§ DAG éªŒè¯å™¨åˆå§‹åŒ–å®Œæˆ', 'success');
        });
        
        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // æµ‹è¯•æ•°æ®
        function loadSimpleDAG() {
            const nodes = [
                { id: 'node1', type: 'PROMPT_BUILD', label: 'PROMPT_BUILD' },
                { id: 'node2', type: 'CALL_LLM', label: 'CALL_LLM' },
                { id: 'node3', type: 'HTTP_REQUEST', label: 'HTTP_REQUEST' },
                { id: 'node4', type: 'CODE_EXEC', label: 'CODE_EXEC' }
            ];
            
            const edges = [
                { source: 'node1', target: 'node2' },
                { source: 'node2', target: 'node3' },
                { source: 'node3', target: 'node4' }
            ];
            
            dag.loadData(nodes, edges, 'hierarchical');
            updateStatus('ç®€å• DAG åŠ è½½å®Œæˆ - 4ä¸ªèŠ‚ç‚¹ï¼Œ3æ¡è¿çº¿', 'success');
        }
        
        function loadComplexDAG() {
            const nodes = [];
            const edges = [];
            const types = ['PROMPT_BUILD', 'CALL_LLM', 'HTTP_REQUEST', 'CODE_EXEC'];
            
            // ç”Ÿæˆ12ä¸ªèŠ‚ç‚¹
            for (let i = 1; i <= 12; i++) {
                nodes.push({
                    id: `node${i}`,
                    type: types[(i - 1) % 4],
                    label: `${types[(i - 1) % 4]} ${i}`
                });
            }
            
            // ç”Ÿæˆå¤æ‚è¿çº¿
            for (let i = 1; i < 12; i++) {
                if (i % 3 !== 0) {
                    edges.push({ source: `node${i}`, target: `node${i + 1}` });
                }
                if (i <= 8) {
                    edges.push({ source: `node${i}`, target: `node${i + 4}` });
                }
            }
            
            dag.loadData(nodes, edges, 'grid');
            updateStatus('å¤æ‚ DAG åŠ è½½å®Œæˆ - 12ä¸ªèŠ‚ç‚¹ï¼Œå¤šé‡ä¾èµ–', 'success');
        }
        
        function loadRealDAG() {
            // æ¨¡æ‹ŸçœŸå®çš„29èŠ‚ç‚¹æ•°æ®
            const nodes = [];
            const edges = [];
            const types = ['PROMPT_BUILD', 'CALL_LLM', 'HTTP_REQUEST', 'CODE_EXEC'];
            
            // ç”Ÿæˆ29ä¸ªèŠ‚ç‚¹ï¼ˆæ¨¡æ‹ŸçœŸå®æ•°æ®è§„æ¨¡ï¼‰
            for (let i = 1; i <= 29; i++) {
                nodes.push({
                    id: `task_${i}`,
                    type: types[(i - 1) % 4],
                    label: `Task ${i}`
                });
            }
            
            // ç”Ÿæˆå¤æ‚ä¾èµ–å…³ç³»
            for (let i = 1; i < 29; i++) {
                // é¡ºåºä¾èµ–
                if (i % 4 !== 0) {
                    edges.push({ source: `task_${i}`, target: `task_${i + 1}` });
                }
                // è·¨å±‚ä¾èµ–
                if (i <= 25) {
                    edges.push({ source: `task_${i}`, target: `task_${i + 4}` });
                }
                // éšæœºä¾èµ–
                if (i <= 20 && Math.random() > 0.7) {
                    edges.push({ source: `task_${i}`, target: `task_${i + 8}` });
                }
            }
            
            dag.loadData(nodes, edges, 'hierarchical');
            updateStatus('çœŸå®æ•°æ® DAG åŠ è½½å®Œæˆ - 29ä¸ªèŠ‚ç‚¹ï¼Œå¤æ‚ä¾èµ–å…³ç³»', 'success');
        }
        
        function testLayouts() {
            if (dag.nodes.length === 0) {
                updateStatus('è¯·å…ˆåŠ è½½æ•°æ®å†æµ‹è¯•å¸ƒå±€', 'error');
                return;
            }
            
            // åˆ‡æ¢å¸ƒå±€ç®—æ³•
            const currentIsGrid = dag.nodes[0].x % 150 === 50; // ç®€å•åˆ¤æ–­å½“å‰å¸ƒå±€
            
            if (currentIsGrid) {
                dag.calculateHierarchicalLayout(dag.nodes, dag.edges);
                updateStatus('å·²åˆ‡æ¢åˆ°å±‚æ¬¡å¸ƒå±€', 'info');
            } else {
                dag.calculateGridLayout(dag.nodes);
                updateStatus('å·²åˆ‡æ¢åˆ°ç½‘æ ¼å¸ƒå±€', 'info');
            }
            
            dag.render();
        }
        
        function clearCanvas() {
            dag.clear();
            updateStatus('ç”»å¸ƒå·²æ¸…ç©º', 'info');
        }
    </script>
</body>
</html> 